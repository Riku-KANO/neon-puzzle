# Neon Circuit 設計書（Draft v0.1）

## 0. 一言コンセプト

暗い都市上空に浮かぶ“回路島”を俯瞰視点で操作し、ブロック回転だけで電力を通して復旧させる3Dパズル。成功すると盤面外周のタイルが波紋のように発光し、都市全体が称賛する。

---

## 1. ゲームのゴールと体験設計

### 1.1 プレイヤー体験（核）

* **観察**：俯瞰で全体構造（回路網）を把握
* **仮説**：どのブロックを回せば通電が繋がるかを推理
* **操作**：クリックでブロックを90°回転（操作はこれだけ）
* **即時フィードバック**：通電がリアルタイムで流れ、正誤の気持ちよさが出る
* **達成演出**：外周タイルが「称賛」する（成功の快感を最大化）

### 1.2 勝利条件

* 電源ノード `S` からゴールノード `T` まで、通電可能な接続が成立した状態になる。

### 1.3 失敗条件（任意・MVPでは省略可）

* 基本は失敗なし（詰まっても回し直せる）。
* Hard以降で追加可能：過負荷（デコイ回路の同時通電）で一時的に遮断 → 数秒後復帰。

---

## 2. 画面構成とシームレス遷移（ワンシーン方式）

### 2.1 原則

* **three.jsのSceneは1つ**。メニュー領域とプレイ領域を同一シーン内に配置し、カメラ移動で遷移する。
* ロード画面を作らない（必要ならフェード・被写界深度・ブラーで隠す）。

### 2.2 エリア配置（例）

* `MenuArea`：タイトル・難易度選択・Startボタン（3D UI）
* `PlayArea`：回路島（盤面）
* `CelebrationRing`：外周称賛タイル（PlayAreaを囲む）
* `BackgroundCity`：遠景都市 + 粒子（雰囲気）

### 2.3 カメラ設計（俯瞰）

* 基本：斜め上からの俯瞰（isometric寄りでも可）
* `cameraRig`（Group）を用意し、カメラはRigの子にする

#### 遷移：Menu → Play（例：1.8s）

* Rigがスプライン（曲線）に沿って移動
* 同時に：

  * FOV：少し狭める（集中）
  * DOF：盤面中心へフォーカス
  * Bloom：微増（高揚）
  * BGM：フィルタ開放（盛り上がる）

#### 遷移：Play → Menu（例：1.2s）

* 逆再生。成功直後は帰還ではなく “リザルトUIだけ出す” なども可。

---

## 3. 入力と操作

### 3.1 操作原則

* 操作は **回転のみ**（90°ステップ）
* マウス／タッチ対応
* 俯瞰固定のため、カメラ回転は原則なし（必要なら軽いパンのみ）

### 3.2 操作仕様

* ブロックをクリック → 右回転（90°）
* Shift+クリック or 右クリック → 左回転（任意）
* 回転は **アニメーション（例 120ms）**で気持ちよく
* 回転中に通電判定は「中間状態を無視して」スナップ後に更新（見た目が安定する）

---

## 4. 盤面モデル（グラフ）

### 4.1 コア定義

* 盤面はグラフ `G = (V, E)`
* `V`: ノード（端子・中継点・S/T）
* `E`: 接続可能な候補辺（ブロックの向きで有効/無効が変化）

### 4.2 ブロック（ノード）モデル

各ノードは「向き」により、開いているポート（接続方向）が変化する。

* 例：ポート集合 `ports(rotation)`

  * Straight：向かい合う2ポート
  * Elbow：直角2ポート
  * Tee：3ポート
  * Cross：4ポート（Hard以降）

※ 3D表現だが、論理は「方向ラベル（N/E/S/W/Up/Down）」で扱う。

### 4.3 通電判定

* 現在回転状態から “有効辺” を構築し、`S` から BFS/DFS で到達可能性を確認
* 通電ラインの演出用に、到達木（親情報）も生成しておく

---

## 5. レベル自動生成（フロント完結 + WASM）

### 5.1 方針：Solved-first

1. まず「解となる回路（解グラフ）」を作る
2. デコイ分岐を追加して探索要素を作る
3. ブロック種別に落とす（ポート整合）
4. 回転を崩して問題化
5. ソルバで評価し、難易度条件を満たすまでリジェクト生成

### 5.2 難易度パラメータ（プリセット）

* `target_min_moves`：最短手数の目標範囲
* `path_len`：解パス長
* `branch_factor`：分岐量
* `loop_ratio`：ループ率（Hardで上げる）
* `types_enabled`：ブロック種類（EasyはStraight/Elbowのみ等）
* `initial_entropy`：初期回転の乱れ（手数に影響）
* `uniqueness`：唯一解を要求するか

例：

* Easy：min_moves 4–7、分岐少、ループなし、Straight/Elbow
* Normal：min_moves 8–12、分岐中、Tee追加
* Hard：min_moves 13–20、ループあり、Cross追加（＋任意で一方通行等）

### 5.3 ソルバ（評価）

* 状態：各ブロックの回転値（0..k-1）
* 操作：あるノードを1回回転
* 目的：通電成立

アルゴリズム：

* Easy/Normal：BFS（最短保証）
* Hard：A*（ヒューリスティック導入）
  評価指標：
* `min_moves`（最短手数）
* `num_solutions`（解の数。1なら唯一解）
* `search_nodes`（探索ノード数＝体感難易度に近い）

採用条件（例）：

* 指定難易度ごとの `min_moves` 範囲に入る
* `num_solutions == 1`（任意だが推奨）
* `search_nodes` が上限を超えない（WASM計算時間制御）

### 5.4 WASMとJSの責務分割

* WASM（Rust推奨）

  * 生成（Solved-first + リジェクト）
  * ソルブ（BFS/A*）
  * 難易度評価
  * シード乱数（再現性）
* JS/TS

  * three.js 描画
  * 入力・回転アニメ
  * 通電の見た目反映
  * 設定読込・UI

---

## 6. ビジュアル & エフェクト設計（演出の仕様）

## 6.1 通電表現（常時フィードバック）

### 6.1.1 2レイヤ構成

* ベース発光（薄く常時）
* 電流スキャン（明るい帯が流れる）

### 6.1.2 表現仕様（例）

* エッジごとに `u: 0..1` を持つ
* シェーダで `time` に応じて発光帯が `u` 方向へ移動
* 通電到達したエッジのみスキャンを有効化

### 6.1.3 操作時

* ブロック回転完了後に通電を更新
* 更新時に「パチッ」という瞬間発光（短いBloomパルス）

---

## 6.2 成功演出：外周タイル称賛（必須）

`CelebrationRing` は **PlayAreaの外周**に常設。InstancedMeshで描画し、GPUで発光制御。

### 6.2.1 タイムライン（推奨）

1. **Snap（0.0–0.2s）**

   * 全体Bloomが一瞬強くなる
   * 通電ラインが太く・明るくなる（短時間）
2. **Ripple（0.2–1.2s）**

   * 外周タイルが波紋のように順番に点灯
   * 方向は `S→T` の到達木の方向性に合わせる（意味付け）
3. **Chant（1.2–3.0s）**

   * 外周が呼吸するように明滅（sin波）
   * 微粒子が上昇（都市が祝福している演出）

### 6.2.2 タイル発光の仕様

* タイルごとに `phase`（点灯開始時間）と `intensity` を持つ
* 成功時、`phase` をリング順にセット（Ripple）
* `intensity = f(time - phase)` をシェーダで計算
* 手数評価に応じて演出差分：

  * 最短一致：位相が綺麗に揃う（拍手）
  * 手数超過：少し位相が揺れる（でも称賛はする）

---

## 6.3 メニューUI演出（3D UI）

* タイトル：ネオン管風（エミッシブ）
* 難易度：ノブ/スライダー風（触っている感）
* Start：押すと微小なスパーク、カメラがPlayAreaへ移動

---

## 7. オーディオ設計（雰囲気の最後のピース）

* 通電：低いハム音（通電量に応じてわずかに変化）
* 回転：クリック＋モーター（短い）
* 成功：3段階に合わせてSEも3段階（Snap/Ripple/Chant）
* カメラ遷移：風切り音 or スッと開くパッド

（サーバ不要。WebAudioでOK）

---

## 8. データ設計（設定駆動を前提）

### 8.1 設定の原則

* 変更可能なものは極力 `config.json` に寄せる
* “演出の数値” をコードに散らさない（後で調整が地獄になる）

### 8.2 コンフィグ項目（例）

* `ThemeConfig`：色、霧、Bloom、材質パラメータ
* `CameraRouteConfig`：Menu→Playのルート、時間、FOV、DOF
* `FxConfig`：成功演出タイムライン（Snap/Ripple/Chant）
* `DifficultyPresets`：生成パラメータと評価条件
* `ControlsConfig`：回転方向、回転時間など

---

## 9. パフォーマンス方針（フロント完結の安全策）

* 外周タイル：InstancedMesh（必須）
* 粒子：数を固定し、画面解像度に応じてスケール
* ポストプロセス：Bloomは強力だが重い → 設定でON/OFFできるように
* WASM生成：メインスレッドを止めない（Web Worker + WASM推奨）

---

## 10. MVPスコープ（最初に完成させる範囲）

### 10.1 MVPに入れる

* ブロック種類：Straight / Elbow / Tee（Normalまで）
* 盤面：中サイズ（例：ノード 18〜30）
* 生成：Solved-first + BFS評価
* 3D UI：MenuArea、Start、難易度選択
* カメラ遷移：Menu→Play（Spline）
* 成功演出：外周Ripple + Bloomパルス（まずここまで）

### 10.2 MVPでは入れない（後回し）

* 物理崩壊
* 一方通行（ダイオード）
* 複数電源・複数ゴール
* リプレイ共有（seed URL）は次点で入れると強い
